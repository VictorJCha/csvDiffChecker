<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f5f7fa;
        margin: 0;
        padding: 0;
      }

      .container {
        padding: 20px;
        overflow-x: auto;
      }

      .card {
        background: #ffffff;
        border-radius: 8px;
        padding: 24px 28px;
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        text-align: center;
      }

      h2 {
        margin-top: 0;
        margin-bottom: 12px;
        font-size: 18px;
      }

      p {
        margin: 0 0 16px;
        color: #555;
        font-size: 13px;
      }

      .file-wrapper {
        display: flex;
        justify-content: center;
        margin: 12px 0 20px;
      }

      input[type="file"] {
        display: inline-block;
      }

      button {
        background: #1a73e8;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        width: 220px;
        display: block;
        margin: 0 auto 12px auto;
      }

      button:hover {
        background: #1558b0;
      }

      #loading {
        display: none;
        margin-top: 20px;
      }

      .spinner {
        margin: 0 auto 10px;
        width: 36px;
        height: 36px;
        border: 4px solid #ddd;
        border-top: 4px solid #1a73e8;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .loading-text {
        font-size: 13px;
        color: #555;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      th, td {
        border: 1px solid #ccc;
        padding: 6px 8px;
        font-size: 12px;
        text-align: left;
        white-space: nowrap;
      }

      th {
        background-color: #000;
        color: #fff;
        position: sticky;      /* freeze the header row */
        top: 0;                /* stick to the top of the table container */
        z-index: 2;            /* ensure it stays above table cells */
      }

      #results {
        overflow-x: auto;
        max-height: 600px;
        overflow-y: auto;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .legend {
        display: flex;
        gap: 12px;
        align-items: center;
        font-size: 12px;
      }

      .legend div {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .legend span.color-box {
        width: 16px;
        height: 16px;
        display: inline-block;
      }

      /* Initially hidden */
      #result-section {
        display: none;
      }

    </style>
  </head>
  <body>
    <div class="container">
      <!-- FILE UPLOAD CARD -->
      <div class="card" id="upload-card">
        <h2>Network CSV Comparison</h2>
        <p>Select the 3 CSV files to compare</p>

        <div class="file-wrapper">
          <input type="file" id="files" accept=".csv" multiple>
        </div>

        <button onclick="submitFiles()">Run Comparison</button>

        <div id="loading">
          <div class="spinner"></div>
          <div class="loading-text">Processing filesâ€¦</div>
        </div>
      </div>

      <!-- RESULTS SECTION -->
      <!-- Results + header -->
      <div class="card" id="resultsCard" style="display:none;">
        <div class="header-row" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <h3 id="resultsHeader">Comparison Results</h3> <!-- Add an id here -->
          <button onclick="resetApp()" style="width:120px;">Reset</button>
        </div>

        <!-- Color legend -->
        <div id="legend" style="display:flex; gap:15px; margin-bottom:10px; flex-wrap:wrap;">
          <div style="display:flex; align-items:center; gap:5px;">
            <div style="width:20px; height:20px; background-color:#cfe2f3;"></div> Matches NSS/Correct
          </div>
          <div style="display:flex; align-items:center; gap:5px;">
            <div style="width:20px; height:20px; background-color:#f4cccc;"></div> Mismatch (Needs Correction)
          </div>
          <div style="display:flex; align-items:center; gap:5px;">
            <div style="width:20px; height:20px; background-color:#fff2cc;"></div> Missing From Platform
          </div>
        </div>

        <div id="results"></div>
      </div>

    <script>
      function submitFiles() {
        const input = document.getElementById('files');
        if (input.files.length !== 3) {
          alert('Please select exactly 3 CSV files.');
          return;
        }

        document.getElementById('loading').style.display = 'block';

        const readers = [];
        for (let i = 0; i < input.files.length; i++) {
          readers.push(new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => resolve({
              name: input.files[i].name,
              content: e.target.result
            });
            reader.readAsText(input.files[i]);
          }));
        }

        Promise.all(readers).then(files => {
          google.script.run
            .withSuccessHandler(result => {
              // result now has mismatches + projectName
              displayResults(result.mismatches);
              const header = document.getElementById('resultsHeader');
              header.textContent = `Comparison Results for ${result.projectName || "current project"}`;
            })
            .withFailureHandler(err => {
              alert(err.message || err);
            })
            .processFilesForWeb(files);
        });
      }

      function displayResults(mismatches) {
        document.getElementById('upload-card').style.display = 'none';
        document.getElementById('resultsCard').style.display = 'block';
        document.getElementById('loading').style.display = 'none';

        if (!mismatches || mismatches.length === 0) {
          document.getElementById('results').innerHTML = '<p>No mismatches found.</p>';
          return;
        }

        let html = `<table>
          <thead>
            <tr>
              <th>IP Address</th>
              <th>Master Name</th>
              <th>UniFi Name</th>
              <th>OVRC Name</th>
              <th>Master MAC</th>
              <th>UniFi MAC</th>
              <th>OVRC MAC</th>
            </tr>
          </thead>
          <tbody>`;

        mismatches.forEach(row => {
          html += `<tr>
            <td>${row.ip}</td>
            <td style="background:${getColor(row,'master','name')}">${row.m.name}</td>
            <td style="background:${getColor(row,'u','name')}">${row.u?.name ?? ''}</td>
            <td style="background:${getColor(row,'o','name')}">${row.o?.name ?? ''}</td>
            <td style="background:${getColor(row,'master','mac')}">${row.m.mac}</td>
            <td style="background:${getColor(row,'u','mac')}">${row.u?.mac ?? ''}</td>
            <td style="background:${getColor(row,'o','mac')}">${row.o?.mac ?? ''}</td>
          </tr>`;
        });

        html += `</tbody></table>`;
        document.getElementById('results').innerHTML = html;

        document.querySelectorAll('#results tbody tr').forEach(row => {
          row.addEventListener('click', () => {
            document.querySelectorAll('#results tbody tr')
              .forEach(r => r.classList.remove('highlight'));
            row.classList.add('highlight');
          });
        });
      }

      // Color logic
      function getColor(row, type, field) {
        const COLORS = {
          master: '#cfe2f3',
          match: '#cfe2f3',
          mismatch: '#f4cccc',
          missing: '#fff2cc'
        };

        if (type === 'master') return COLORS.master;

        const ref = type === 'u' ? row.u : row.o;
        if (!ref) return COLORS.missing;

        if (field === 'name') {
          if (!ref.name) return COLORS.missing;
          return ref.name.trim() === row.m.name.trim()
            ? COLORS.match
            : COLORS.mismatch;
        }

        if (field === 'mac') {
          if (!ref.mac) return COLORS.missing;
          const m = (row.m.mac || '').toUpperCase().replace(/[^0-9A-F]/g,'');
          const r = (ref.mac || '').toUpperCase().replace(/[^0-9A-F]/g,'');
          return m === r ? COLORS.match : COLORS.mismatch;
        }
      }

      // === Row highlight CSS (inject once) ===
      const style = document.createElement('style');
      style.innerHTML = `
        .highlight td {
          border-top: 2px solid #000000;
          border-bottom: 2px solid #000000;
        }

        .highlight td:first-child {
          border-left: 2px solid #000000;
        }

        .highlight td:last-child {
          border-right: 2px solid #000000;
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>
